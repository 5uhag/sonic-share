(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const e of i)if(e.type==="childList")for(const a of e.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const e={};return i.integrity&&(e.integrity=i.integrity),i.referrerPolicy&&(e.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?e.credentials="include":i.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(i){if(i.ep)return;i.ep=!0;const e=n(i);fetch(i.href,e)}})();class C{constructor(t,n={}){this.ctx=t,this.config={mark:n.mark||19e3,space:n.space||18500,duration:n.duration||.1,...n}}generateSignal(t){let n=this.ctx.currentTime;[1,1,1,1,1,0,0,1,1,0,1,0,1].concat(t).forEach((e,a)=>{const h=this.ctx.createOscillator(),c=this.ctx.createGain(),u=e===1?this.config.mark:this.config.space,l=n+a*this.config.duration,f=l+this.config.duration;h.frequency.setValueAtTime(u,l),c.gain.setValueAtTime(0,l),c.gain.linearRampToValueAtTime(1,l+this.config.duration*.1),c.gain.setValueAtTime(1,f-this.config.duration*.1),c.gain.linearRampToValueAtTime(0,f),h.connect(c),c.connect(this.ctx.destination),h.start(l),h.stop(f)})}}class D{constructor(t,n={}){this.ctx=t,this.config={mark:n.mark||19e3,space:n.space||18500,duration:n.duration||.1,...n},this.analyser=this.ctx.createAnalyser(),this.analyser.fftSize=2048,this.dataArray=new Float32Array(this.analyser.frequencyBinCount),this.filter=this.ctx.createBiquadFilter(),this.filter.type="bandpass",this.filter.frequency.value=(this.config.mark+this.config.space)/2,this.filter.Q.value=5;const s=this.ctx.sampleRate/2;this.markBin=Math.round(this.config.mark/s*this.analyser.frequencyBinCount),this.spaceBin=Math.round(this.config.space/s*this.analyser.frequencyBinCount),this.source=null,this.isListening=!1,this.onBitReceived=null,this.onByteReceived=null,this.preamble=[1,1,1,1,1,0,0,1,1,0,1,0,1],this.bitBuffer=[],this.isSyncLocked=!1,this.isSyncLocked=!1,this.noiseThreshold=-85,this.lastProcessTime=0}async startMicrophone(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Microphone API is not available. This is usually because the site is not running on HTTPS.");try{const t=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});this.source=this.ctx.createMediaStreamSource(t),this.source.connect(this.filter),this.filter.connect(this.analyser),this.isListening=!0,this.processLoop()}catch(t){throw console.error("Microphone access denied:",t),t}}stopMicrophone(){this.isListening=!1,this.source&&(this.source.disconnect(),this.source.mediaStream.getTracks().forEach(t=>t.stop()),this.source=null)}processLoop(t){if(!this.isListening||(requestAnimationFrame(e=>this.processLoop(e)),t-this.lastProcessTime<this.config.duration*1e3*.8))return;this.analyser.getFloatFrequencyData(this.dataArray);const n=this.dataArray[this.markBin],s=this.dataArray[this.spaceBin];let i=-1;(n>this.noiseThreshold||s>this.noiseThreshold)&&(n>s+2?(i=1,this.lastProcessTime=t):s>n+2&&(i=0,this.lastProcessTime=t)),i!==-1&&(this.bitBuffer.push(i),this.onBitReceived&&this.onBitReceived(i,Math.max(n,s)),this.bitBuffer.length>this.preamble.length+8&&this.bitBuffer.shift(),this.checkForSyncAndDecode())}checkForSyncAndDecode(){if(this.bitBuffer.length<this.preamble.length)return;let t=0;for(let n=0;n<this.preamble.length;n++)this.bitBuffer[n]===this.preamble[n]&&t++;if(t>=this.preamble.length-3&&!this.isSyncLocked&&(this.isSyncLocked=!0,console.log("SYNC LOCKED: Barker preamble detected")),this.isSyncLocked&&this.bitBuffer.length>=this.preamble.length+8){const n=this.bitBuffer.slice(this.preamble.length,this.preamble.length+8),s=parseInt(n.join(""),2),i=String.fromCharCode(s);this.onByteReceived&&this.onByteReceived(i),this.bitBuffer=[],this.isSyncLocked=!1}}}class F{constructor(t){this.ctx=t,this.SYNC=9,this.SEPARATOR=1.5,this.PIXEL=.432,this.SYNC_FREQ=1200,this.SEP_FREQ=1500,this.BLACK_FREQ=1500,this.WHITE_FREQ=2300,this.RANGE=this.WHITE_FREQ-this.BLACK_FREQ,this.VIS_CODE=[0,0,1,1,1,1,0,0]}scheduleTone(t,n,s,i){return t.frequency.setValueAtTime(n,i),i+s/1e3}generateSignal(t,n){const s=this.ctx.createOscillator(),i=this.ctx.createGain();s.connect(i),i.connect(this.ctx.destination);let e=this.ctx.currentTime+.1;i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(1,e+.05),e=this.scheduleTone(s,1900,300,e),e=this.scheduleTone(s,1200,10,e),e=this.scheduleTone(s,1900,300,e),e=this.scheduleTone(s,1200,30,e);for(const c of this.VIS_CODE){const u=c===1?1100:1300;e=this.scheduleTone(s,u,30,e)}e=this.scheduleTone(s,1200,30,e);const a=320,h=256;e=this.scheduleTone(s,this.SYNC_FREQ,this.SYNC,e);for(let c=0;c<h;c++){const u=c*a*4;for(const l of[1,2,0]){l===0&&(e=this.scheduleTone(s,this.SYNC_FREQ,this.SYNC,e)),e=this.scheduleTone(s,this.SEP_FREQ,this.SEPARATOR,e);for(let f=0;f<a;f++){const k=t.data[u+f*4+l],w=this.BLACK_FREQ+this.RANGE*(k/255);e=this.scheduleTone(s,w,this.PIXEL,e)}}}return i.gain.setValueAtTime(1,e),i.gain.linearRampToValueAtTime(0,e+.05),e+=.05,s.start(this.ctx.currentTime+.1),s.stop(e),s.onended=()=>{s.disconnect(),i.disconnect(),n&&n()},e-this.ctx.currentTime}}let m=null,d=null,E=null,x=null;function P(){if(!m){m=new(window.AudioContext||window.webkitAudioContext);const o=g?{mark:3e3,space:2500,duration:.1}:{mark:19500,space:18500,duration:.1};d=new C(m,o),E=new D(m,o),x=new F(m),connectVisualizer(E.analyser),E.onByteReceived=t=>{const n=document.getElementById("rx-output"),s=n.querySelector(".placeholder-text");s&&(s.innerText=""),n.innerHTML+=t,n.scrollTop=n.scrollHeight},E.onBitReceived=(t,n)=>{}}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(o=>{console.log("ServiceWorker registration successful with scope: ",o.scope),document.getElementById("connection-status").innerText="OFFLINE READY",document.querySelector(".dot").classList.replace("offline","online")}).catch(o=>{console.log("ServiceWorker registration failed: ",o),document.getElementById("connection-status").innerText="SW FAILED"})});const T=document.getElementById("tuning-knob"),r=T.getContext("2d"),S=document.getElementById("current-band"),L=document.getElementById("rx-log"),M=document.getElementById("btn-transmit"),O=document.getElementById("file-input"),b=document.getElementById("theme-toggle");let A=localStorage.getItem("theme")==="dark";A&&(document.body.setAttribute("data-theme","dark"),b.innerText="LIGHT");b.addEventListener("click",()=>{A=!A,A?(document.body.setAttribute("data-theme","dark"),b.innerText="LIGHT",localStorage.setItem("theme","dark")):(document.body.removeAttribute("data-theme"),b.innerText="DARK",localStorage.setItem("theme","light")),I(B)});let g=!0,B=0;function I(o){const t=T.width,n=T.height,s=t/2,i=n/2,e=45;r.clearRect(0,0,t,n);const a=getComputedStyle(document.body),h=a.getPropertyValue("--text-main").trim(),c=a.getPropertyValue("--panel-bg").trim();r.beginPath(),r.arc(s,i,e+5,0,2*Math.PI),r.fillStyle=h,r.fill(),r.beginPath(),r.arc(s,i,e,0,2*Math.PI),r.fillStyle=c,r.fill(),r.lineWidth=4,r.strokeStyle=h,r.stroke(),r.beginPath(),r.moveTo(s,i);const u=s+Math.cos(o)*(e-10),l=i+Math.sin(o)*(e-10);r.lineTo(u,l),r.lineWidth=6,r.stroke(),Math.abs(o)>Math.PI/2?g&&(g=!1,S.innerText="ULTRASONIC (18-21kHz)",S.style.background="#000",d&&(d.config={...d.config,mark:19500,space:18500})):g||(g=!0,S.innerText="AUDIBLE (1-5kHz)",S.style.background="var(--accent-1)",d&&(d.config={...d.config,mark:3e3,space:2500}))}let v=!1;T.addEventListener("mousedown",o=>{v=!0,R(o)});window.addEventListener("mouseup",()=>{v=!1});window.addEventListener("mousemove",o=>{v&&R(o)});function R(o){const t=T.getBoundingClientRect(),n=t.left+t.width/2,s=t.top+t.height/2;B=Math.atan2(o.clientY-s,o.clientX-n),I(B)}I(0);function p(o){const t=document.createElement("span"),n=new Date().toLocaleTimeString("en-US",{hour12:!1});t.innerText=`[${n}] ${o}`,L.appendChild(t),L.scrollTop=L.scrollHeight}let y=null;O.addEventListener("change",o=>{const t=o.target.files[0];if(t){p(`FILE SELECTED: ${t.name} (${t.size} bytes)`);const n=new FileReader;n.onload=function(s){if(t.type.startsWith("image/")){const i=new Image;i.onload=()=>{const e=document.createElement("canvas");e.width=320,e.height=256;const a=e.getContext("2d",{willReadFrequently:!0});a.drawImage(i,0,0,320,256),y=a.getImageData(0,0,320,256),document.getElementById("payload-input").value=`[IMAGE LOADED FOR SSTV: ${t.name}]`,p("IMAGE ENCODED: Ready for SSTV Scottie S1 Transmission")},i.src=s.target.result}else{y=null;const i=s.target.result,e=document.getElementById("payload-input");e.value=i,p(`FILE ENCODED: Ready to transmit ${i.length} chars via FSK...`)}},n.readAsDataURL(t)}});M.addEventListener("click",()=>{P();const o=document.getElementById("payload-input").value;if(!o.trim()&&!y)return alert("Enter a message or select an image to transmit.");if(m.state==="suspended"&&m.resume(),y)p("TX SSTV STARTED [Scottie S1]: ~111 seconds..."),x.generateSignal(y,()=>{p("TX SSTV COMPLETE.")});else{p(`TX FSK STARTED [${g?"AUDIBLE":"ULTRASONIC"}]: ${o.substring(0,15)}...`);const t=[];for(let n=0;n<o.length;n++){const s=o.charCodeAt(n).toString(2).padStart(8,"0");for(let i=0;i<8;i++)t.push(parseInt(s[i]))}d.generateSignal(t)}});
